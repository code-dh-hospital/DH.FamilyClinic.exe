name: Create release on push (zip)
on: push
permissions:
  contents: write

jobs:
  create_release:
    name: Create release (zip) on push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: make_zip
        name: Create zip of repository
        run: |
          set -euo pipefail
          ZIP_NAME="repo-release-${{ github.run_id }}.zip"
          # Exclude .git and workflow files so we don't leak CI metadata
          zip -r "$ZIP_NAME" . -x ".git/*" ".github/workflows/*"
          echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"

      - name: Install GitHub CLI (gh)
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Create release and upload asset using gh (uses GITHUB_TOKEN)
        env:
          ZIP_NAME: ${{ steps.make_zip.outputs.zip_name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="release-${{ github.run_id }}"
          TITLE="Automated release ${{ github.run_id }} (branch: ${{ github.ref_name }})"
          NOTES="Automated release created by GitHub Actions.Run ID: ${{ github.run_id }}. Commit: ${{ github.sha }}"
          # Create the release (or upload asset if release already exists)
          if gh release create "$TAG" "$ZIP_NAME" --title "$TITLE" --notes "$NOTES"; then
            echo "Release created and asset uploaded."
          else
            echo "Release may already exist â€” uploading asset (clobber) to ${TAG}..."
            gh release upload "$TAG" "$ZIP_NAME" --clobber
          fi
